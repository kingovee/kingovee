{% extends "base.html" %}

{% block content %}
<div class="quiz-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Educational Quiz</h2>
        <div id="progress-text" class="text-muted">Question 0 of 0</div>
    </div>
    
    <div class="progress mb-4" style="height: 10px;">
        <div id="quiz-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
    </div>
    
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading quiz questions...</p>
    </div>
    
    <div id="student-info" class="card mb-4 d-none">
        <div class="card-body">
            <h5 class="card-title">Before we start</h5>
            <div class="mb-3">
                <label for="student-name" class="form-label">Your Name</label>
                <input type="text" class="form-control" id="student-name" placeholder="Enter your name">
            </div>
            <button id="start-quiz" class="btn btn-primary">Start Quiz</button>
        </div>
    </div>
    
    <form id="quiz-form" class="d-none">
        <div id="questions-container"></div>
        
        <div class="d-flex justify-content-between mt-4">
            <button type="button" id="prev-btn" class="btn btn-outline-primary d-none">
                <i class="fas fa-arrow-left me-1"></i> Previous
            </button>
            <button type="button" id="next-btn" class="btn btn-primary ms-auto">
                Next <i class="fas fa-arrow-right ms-1"></i>
            </button>
            <button type="submit" id="submit-btn" class="btn btn-success d-none">
                Submit Quiz <i class="fas fa-check ms-1"></i>
            </button>
        </div>
    </form>
    
    <div id="results" class="card d-none">
        <div class="card-body text-center">
            <i class="fas fa-check-circle fa-5x text-success mb-3"></i>
            <h3>Quiz Completed!</h3>
            <div class="score-display my-4">
                Your score: <span id="score-value">0</span> / <span id="max-score-value">0</span>
                (<span id="score-percentage">0</span>%)
            </div>
            <p class="text-muted" id="results-message">Well done!</p>
            <a href="/quiz" class="btn btn-primary mt-3">Take Another Quiz</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let questions = [];
        let currentQuestion = 0;
        let studentName = '';
        let answers = {};
        
        // DOM elements
        const loadingEl = document.getElementById('loading');
        const studentInfoEl = document.getElementById('student-info');
        const quizFormEl = document.getElementById('quiz-form');
        const questionsContainerEl = document.getElementById('questions-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const resultsEl = document.getElementById('results');
        const progressBar = document.getElementById('quiz-progress');
        const progressText = document.getElementById('progress-text');
        
        // Fetch questions from API
        fetch('/api/questions')
            .then(response => response.json())
            .then(data => {
                questions = data;
                loadingEl.classList.add('d-none');
                studentInfoEl.classList.remove('d-none');
            })
            .catch(error => {
                console.error('Error:', error);
                loadingEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load questions. Please try again later.
                    </div>
                    <a href="/quiz" class="btn btn-primary mt-3">Reload</a>
                `;
            });
        
        // Start quiz button
        document.getElementById('start-quiz').addEventListener('click', function() {
            studentName = document.getElementById('student-name').value.trim();
            if (!studentName) {
                alert('Please enter your name to start the quiz.');
                return;
            }
            
            studentInfoEl.classList.add('d-none');
            quizFormEl.classList.remove('d-none');
            renderQuestion(0);
            updateProgress();
        });
        
        // Next button
        nextBtn.addEventListener('click', function() {
            saveAnswer(currentQuestion);
            
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                renderQuestion(currentQuestion);
                updateProgress();
            }
        });
        
        // Previous button
        prevBtn.addEventListener('click', function() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion(currentQuestion);
                updateProgress();
            }
        });
        
        // Form submission
        quizFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            saveAnswer(currentQuestion);
            
            // Prepare submission data
            const submission = {
                student: studentName,
                answers: Object.keys(answers).map(id => ({
                    id: parseInt(id),
                    answer: answers[id]
                }))
            };
            
            // Submit answers
            fetch('/api/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(submission)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show results
                    quizFormEl.classList.add('d-none');
                    resultsEl.classList.remove('d-none');
                    
                    document.getElementById('score-value').textContent = data.score;
                    document.getElementById('max-score-value').textContent = data.max_score;
                    document.getElementById('score-percentage').textContent = data.percentage;
                    
                    // Set message based on score
                    let message = 'Well done!';
                    if (data.percentage < 50) {
                        message = 'Keep practicing!';
                    } else if (data.percentage < 80) {
                        message = 'Good job!';
                    }
                    document.getElementById('results-message').textContent = message;
                } else {
                    alert('Error submitting quiz: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting quiz. Please try again.');
            });
        });
        
        // Render question
        function renderQuestion(index) {
            const question = questions[index];
            questionsContainerEl.innerHTML = '';
            
            const questionEl = document.createElement('div');
            questionEl.className = 'card question-card';
            questionEl.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">Question ${index + 1}</h5>
                    <p class="card-text">${question.question_text}</p>
                    <div class="points-badge badge bg-primary mb-3">${question.points} point${question.points !== 1 ? 's' : ''}</div>
                    
                    ${question.type === 'mcq' ? renderMCQOptions(question, index) : renderOpenEnded(question, index)}
                </div>
            `;
            
            questionsContainerEl.appendChild(questionEl);
            
            // Update navigation buttons
            prevBtn.classList.toggle('d-none', index === 0);
            nextBtn.classList.toggle('d-none', index === questions.length - 1);
            submitBtn.classList.toggle('d-none', index !== questions.length - 1);
        }
        
        // Render MCQ options
        function renderMCQOptions(question, index) {
            let optionsHtml = '<div class="options-list">';
            
            question.options.forEach((option, i) => {
                const isChecked = answers[question.id] === option ? 'checked' : '';
                optionsHtml += `
                    <div class="form-check option-item ${isChecked ? 'selected' : ''}">
                        <input class="form-check-input" type="radio" name="question-${index}" 
                               id="option-${index}-${i}" value="${option}" ${isChecked}>
                        <label class="form-check-label w-100" for="option-${index}-${i}">
                            ${option}
                        </label>
                    </div>
                `;
            });
            
            optionsHtml += '</div>';
            return optionsHtml;
        }
        
        // Render open-ended question
        function renderOpenEnded(question, index) {
            const answer = answers[question.id] || '';
            return `
                <div class="form-group">
                    <textarea class="form-control" name="question-${index}" rows="4" 
                              placeholder="Type your answer here...">${answer}</textarea>
                </div>
            `;
        }
        
        // Save answer
        function saveAnswer(index) {
            const question = questions[index];
            const formData = new FormData(quizFormEl);
            const answer = formData.get(`question-${index}`);
            
            if (answer) {
                answers[question.id] = answer;
            }
        }
        
        // Update progress
        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
        }
        
        // Add event delegation for MCQ option selection styling
        questionsContainerEl.addEventListener('change', function(e) {
            if (e.target.type === 'radio') {
                // Remove selected class from all options
                document.querySelectorAll('.option-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add selected class to the parent of the checked radio
                if (e.target.checked) {
                    e.target.closest('.option-item').classList.add('selected');
                }
            }
        });
    });
</script>
{% endblock %}